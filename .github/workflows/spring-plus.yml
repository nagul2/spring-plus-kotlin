name: Deploy to EC2
on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - run: chmod +x ./gradlew
    - run: ./gradlew clean bootJar

    # ──────────────────────────── SSH 준비
    - name: Prepare SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > ec2_key.pem
        chmod 600 ec2_key.pem
        eval "$(ssh-agent -s)"
        ssh-add ec2_key.pem
        echo "🔑  키 목록 ↓"
        ssh-add -l                      # ← 여기서 fingerprint 안 나오면 키가 깨진 것!

    # ──────────────────────────── 파일 복사 (scp -vvv 로 문제 즉시 확인)
    - name: Copy JAR to EC2
      run: |
        ls -lh build/libs
        scp -vvv -C -o StrictHostKeyChecking=no \
            build/libs/*.jar  ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/app.jar

    # ──────────────────────────── 원격 실행
    - name: Deploy & run
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} <<'EOS'
          pkill -f 'java -jar' || true
          export DB_ID="${{ secrets.DB_ID }}"
          export DB_PW="${{ secrets.DB_PW }}"
          export JWT_SECRETKEY="${{ secrets.JWT_SECRETKEY }}"
          nohup java -jar /home/ubuntu/app.jar --spring.profiles.active=dev > app.log 2>&1 &
        EOS
