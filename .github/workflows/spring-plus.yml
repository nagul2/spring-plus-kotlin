name: Deploy to EC2
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ μ†μ¤ & JDK β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    - uses: actions/checkout@v3

    - uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - run: chmod +x ./gradlew
    - run: ./gradlew clean bootJar        # build/libs/β€¦jar μƒμ„±

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ SSH ν‚¤ μ¤€λΉ„ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # β‘   base64 λ΅ μ €μ¥ν•΄ λ‘” μ‹ν¬λ¦Ώμ„ νμΌλ΅ λ³µνΈν™”
    - name: Write EC2 key
      run: |
        echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > ec2_key.pem
        chmod 600 ec2_key.pem

    # β‘΅  μ—μ΄μ „νΈμ— μ μ¬ β€“> fingerprint κ°€ μ°ν€μ•Ό β€ν‚¤ OKβ€
    - name: Add key to agent
      run: |
        eval "$(ssh-agent -s)"
        ssh-add ec2_key.pem
        echo "π”‘ ν„μ¬ λ΅λ“λ ν‚¤:"
        ssh-add -l

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ jar λ³µμ‚¬ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    - name: Copy JAR to EC2
      run: |
        ls -lh build/libs
        scp -C  -o StrictHostKeyChecking=no \
            -i ec2_key.pem               \            # β† ν‚¤ μ§μ ‘ μ§€μ •
            build/libs/*.jar \
            ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/app.jar

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ μ›κ²© μ‹¤ν–‰ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    - name: Deploy & run
      run: |
        ssh -i ec2_key.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.EC2_HOST }} << 'EOS'
          pkill -f 'java -jar' || true

          export DB_ID="${DB_ID}"
          export DB_PW="${DB_PW}"
          export JWT_SECRETKEY="${JWT_SECRETKEY}"

          nohup java -jar /home/ubuntu/app.jar \
                --spring.profiles.active=dev \
                > app.log 2>&1 &
        EOS
      env:                       # β† μ›κ²© μ‰μ—μ„ λ°”λ΅ μ“Έ μ μκ² μ „λ‹¬
        DB_ID:         ${{ secrets.DB_ID }}
        DB_PW:         ${{ secrets.DB_PW }}
        JWT_SECRETKEY: ${{ secrets.JWT_SECRETKEY }}
