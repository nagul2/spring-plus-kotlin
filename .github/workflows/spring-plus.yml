name: Deploy to EC2
on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - run: chmod +x ./gradlew
    - run: ./gradlew clean bootJar

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSH ì¤€ë¹„
    - name: Prepare SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > ec2_key.pem
        chmod 600 ec2_key.pem
        eval "$(ssh-agent -s)"
        ssh-add ec2_key.pem
        echo "ğŸ”‘  í‚¤ ëª©ë¡ â†“"
        ssh-add -l                      # â† ì—¬ê¸°ì„œ fingerprint ì•ˆ ë‚˜ì˜¤ë©´ í‚¤ê°€ ê¹¨ì§„ ê²ƒ!

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŒŒì¼ ë³µì‚¬ (scp -vvv ë¡œ ë¬¸ì œ ì¦‰ì‹œ í™•ì¸)
    - name: Copy JAR to EC2
      run: |
        ls -lh build/libs
        scp -vvv -C -o StrictHostKeyChecking=no \
            build/libs/*.jar  ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/app.jar

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì›ê²© ì‹¤í–‰
    - name: Deploy & run
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} <<'EOS'
          pkill -f 'java -jar' || true
          export DB_ID="${{ secrets.DB_ID }}"
          export DB_PW="${{ secrets.DB_PW }}"
          export JWT_SECRETKEY="${{ secrets.JWT_SECRETKEY }}"
          nohup java -jar /home/ubuntu/app.jar --spring.profiles.active=dev > app.log 2>&1 &
        EOS
